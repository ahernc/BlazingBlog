@page "/user-overview"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject ISender Sender

<h3>Users Overview</h3>

@if (users is null)
{
    <p>Loading users...</p>
}
else if (users.Count == 0)
{
    <p>No users!</p>
}
else
{
    <div class="grid">
        <QuickGrid Items="@users.AsQueryable()">
            <PropertyColumn Property="@(x => x.UserName)" Sortable="true" Title="User Name"></PropertyColumn>
            <PropertyColumn Property="@(x => x.Email)" Sortable="true" Title="Email Address"></PropertyColumn>
            <PropertyColumn Property="@(x => x.Roles)" Title="Roles"></PropertyColumn>
            <TemplateColumn>
                <button @onclick="()=>OpenModal(context.Id, context.UserName)" class="btn btn-sm btn-outline-primary">
                    🔐 Manage Roles
                </button>
            </TemplateColumn>
        </QuickGrid>
    </div>
}


@code {
    //watch out for the bug about the server rendering twice with prerendering...
    public List<UserResponse>? users = new();
    private bool showModal = false;
    private string selectedUserId = string.Empty;
    private string selectedUserName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var result = await Sender.Send(new GetUsersQuery());
        if (result.Success)
        {
            users = result;
        }
        else
        {
            // to do: deal with the error later...
            users = new();
        }
    }

    private void OpenModal (string userId, string userName)
    {
        selectedUserId = userId;
        selectedUserName = userName;
        showModal = true;
        Console.WriteLine($"Open Modal -> {selectedUserName} // {selectedUserId}");
    }

    private void ToggleShowModal()
    {
        showModal = !showModal;
    }
}
